#!/bin/sh
# Pre-commit hook for FitWatch
# Ensures CI will pass before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Change to repo root
cd "$(git rev-parse --show-toplevel)"

# 1. Format check
echo "üìù Checking formatting..."
UNFORMATTED=$(gofmt -l . 2>/dev/null | grep -v '.project/spikes' || true)
if [ -n "$UNFORMATTED" ]; then
    echo "‚ùå The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w ."
    exit 1
fi
echo "‚úì Formatting OK"

# 2. Lint (if golangci-lint is available)
echo "üî¨ Running linter..."
if command -v golangci-lint >/dev/null 2>&1; then
    golangci-lint run --timeout=5m
    echo "‚úì Lint OK"
else
    echo "‚ö†Ô∏è  golangci-lint not found, running go vet instead"
    go vet ./...
    echo "‚úì Vet OK"
fi

# 3. Build
echo "üî® Building..."
go build ./...
echo "‚úì Build OK"

# 4. Tests (skip integration tests that need credentials)
echo "üß™ Running tests..."
go test -short ./...
echo "‚úì Tests OK"

# 5. Check for secrets in staged files (CRITICAL)
echo "üîê Scanning for secrets..."

STAGED_FILES=$(git diff --cached --name-only 2>/dev/null)
SECRETS_FOUND=0

# Define secret patterns (extended grep patterns)
SECRET_PATTERNS='eyJ[A-Za-z0-9_-]{20,}\.eyJ[A-Za-z0-9_-]{20,}|AKIA[0-9A-Z]{16}|sk-[A-Za-z0-9]{32,}|ghp_[A-Za-z0-9]{36}|-----BEGIN[[:space:]]+(RSA[[:space:]]+)?PRIVATE KEY-----'

for file in $STAGED_FILES; do
    # Skip test files, examples, binary files, and testdata
    case "$file" in
        *_test.go|*_test.js|*_test.ts) continue ;;
        *.example|*.sample|*.template) continue ;;
        *.exe|*.dll|*.bin|*.fit|*.db|*.png|*.jpg|*.gif) continue ;;
        */testdata/*) continue ;;
        .project/spikes/*) continue ;;
    esac
    
    if [ -f "$file" ]; then
        # Check for JWT tokens and other secrets
        if grep -qE "$SECRET_PATTERNS" "$file" 2>/dev/null; then
            echo "‚ùå SECRETS DETECTED in $file"
            SECRETS_FOUND=1
        fi
        
        # Check for API keys and passwords (separate check with looser pattern)
        if grep -qE '(api[_-]?key|apikey|password|passwd|pwd|secret|token)[[:space:]]*[:=][[:space:]]*['"'"'"][A-Za-z0-9_-]{16,}' "$file" 2>/dev/null; then
            case "$file" in
                *_test.go|*.example) ;;  # Skip test files
                *)
                    echo "‚ùå Possible API key/password in $file"
                    SECRETS_FOUND=1
                    ;;
            esac
        fi
    fi
done

if [ "$SECRETS_FOUND" -eq 1 ]; then
    echo ""
    echo "üö® Commit blocked: Secrets detected in staged files!"
    echo "   Remove the secrets and try again."
    exit 1
fi
echo "‚úì No secrets detected"

# 6. Check for common issues
echo "üîé Checking for common issues..."

# Check for large files
LARGE_FILES=$(git diff --cached --name-only | while read f; do
    if [ -f "$f" ]; then
        SIZE=$(wc -c < "$f" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$f ($(($SIZE / 1024))KB)"
        fi
    fi
done)
if [ -n "$LARGE_FILES" ]; then
    echo "‚ö†Ô∏è  Warning: Large files (>1MB):"
    echo "$LARGE_FILES"
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
